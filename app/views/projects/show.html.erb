<% title "Research Project", @project.name %>
<% edit_section_for(@project, @project.projectable) if @project.memberships.where(:user_id => current_user, :role => 'admin').present? || (can? :manage, 'Memberships') %>

<% content_for :add_section do %>
  <li><%= link_to "People", [:edit, @project.projectable, @project] if @project.memberships.where(:user_id => current_user, :role => 'admin').present? || (can? :manage, 'Memberships') %></li>
  <li class="divider"></li>
  <li><%= link_to 'Documents', polymorphic_path([:new, @project, :document]) %></li>
  <li><%= link_to "Introduction document", polymorphic_path([:new, @project, :document], :document_type => "Introduction") unless @project.documents.doctype('Introduction') %></li>
  <li><%= link_to 'Todo', "#add_todo", :'data-toggle' => 'modal' %></li>  
<% end if can? :edit, @project %>

<% content_for :breadcrumbs_section do %>
  <%= content_tag(:li, link_to("Root", root_path) + content_tag(:span, '/', class: 'divider')) %>
  <% if @project.projectable_type == "Group" %>
    <%= content_tag(:li, link_to("#{@project.projectable.cluster.name}", @project.projectable.cluster) + content_tag(:span, '/', class: 'divider')) %>
    <%= content_tag(:li, link_to("Groups", cluster_groups_path(@project.projectable)) + content_tag(:span, '/', class: 'divider')) %>
    <%= content_tag(:li, link_to("#{@project.projectable.name}", @project.projectable) + content_tag(:span, '/', class: 'divider')) %>
  <% end %>
  <%= content_tag(:li, link_to("#{@project.projectable.name}", @project.projectable) + content_tag(:span, '/', class: 'divider')) if @project.projectable_type == "Cluster" %>
  <%= content_tag(:li, link_to("Projects", [@project.projectable, 'projects']) + content_tag(:span, '/', class: 'divider')) %>
  <%= content_tag :li, "#{@project.name}", class: 'active' %>
<% end %>

<% content_for :main_section do %>
    <ul class="nav nav-tabs">
      <%= content_tag :li, link_to('Documents', "#docs", data: {toggle: 'tab'}), class: 'active' %>
      <%= content_tag :li, link_to('Project Todos', "#todos", data: {toggle: 'tab'}) if can? :create, @project.todos %>
      <%= content_tag :li, link_to('Bibliography', "#bib", data: {toggle: 'tab'}) if can? :read, @project.references %>
    </ul>
    <div class="tab-content">
      <div class="tab-pane active" id="docs"> 
        <%= content_tag :h4, 'Documents', class: 'muted' if @project.documents.any? %>
        <%= render "documents/with_document_type", var: @project, dtype: "Introduction" if @project.documents.doctype('Introduction') %>

        <%= render "documents/without_document_type", :var => @project %>
      </div>
      <% if can? :read, @project %>
        <div class="tab-pane" id="todos">
          <p><%= link_to 'Manage Todos', project_todos_path(@project) %></p>
          <div class="accordion" id="todo-accordion">
            <div class="accordion-group">
              <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#todo-accordion" href="#collapseOne">
                  Calendar View
                </a>
              </div>
              <div id="collapseOne" class="accordion-body collapse">
                <div class="accordion-inner">

                  <h2 id="month" class="muted">
                    <%= link_to "<", date: @date.prev_month %>
                    <%= @date.strftime("%B %Y") %>
                    <%= link_to ">", date: @date.next_month %>
                  </h2>
                  <%= calendar @date do |date| %>
                    <%= link_to "#{date.day}"  %>
                    <% if @todos_by_date[date] %>
                      <ul>
                        <% @todos_by_date[date].each do |todo| %>
                        <li><%= todo.name %> (<%= todo.assigned.available_name %>)</li>
                        <% end %>
                      </ul>
                    <% end %>
                  <% end %>
                </div>
              </div>
            </div>
            <div class="accordion-group">
              <div class="accordion-heading">
                <a class="accordion-toggle" data-toggle="collapse" data-parent="#todo-accordion" href="#collapseTwo">
                  List View (<%= pluralize(@project.todos.count, 'todo') %>)
                </a>
              </div>
              <div id="collapseTwo" class="accordion-body collapse in">
                <div class="accordion-inner">
                  <table class="table table-bordered table-hover">
                    <thead>
                      <tr>
                        <td>Task</td>
                        <td>Assigned User</td>
                        <td>Due to</td>
                        <td>Starts at</td>
                        <td>Depends on</td>
                        <td>Done?</td>
                      </tr>
                    </thead>
                    <tbody>
                    <% for todo in @project.todos.order('due_to ASC') do %>
                      <tr>
                        <td><strong><%= link_to todo.name, [todo.project, todo] %></strong></td>
                        <td><%= todo.assigned.available_name %></td>
                        <td><%= todo.due_to.strftime("%d.%m.%Y") %></td>
                        <td><%= todo.starts_at.strftime("%d.%m.%Y") if todo.starts_at %></td>
                        <td><%= todo.dependencies.map{ |a| content_tag :span, a.name, style: (a.completed ? "color:green;" : "color:red;") }.join(", ").html_safe if todo.dependencies.any? %></td>
                        <td><%= content_tag :i, '', class: 'icon-ok' if todo.completed %></td>
                      </tr>
                    <% end %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <%= content_tag :div, class: 'tab-pane', id: 'bib' do %> 
        <p><%= link_to 'View all', project_references_path(@project) %></p>
        <%= content_tag :h4, 'Bibliography', class: 'muted' %>
        <%= render "references/bib_entries", :references => @project.references.order('first_page ASC') %>
      <% end if @project.references.any? %>

    </div>
<% end %>

<% content_for :sidebar_section do %>
    <ul class="nav nav-tabs" style="margin-left:20px;">
      <%= content_tag :li, link_to('Overview', "#overview", data: {toggle: 'tab'}), class: 'active' %>
      <%= content_tag :li, link_to('Members', "#members", data: {toggle: 'tab'}) %>
    </ul>

    <div class="tab-content" id="sidebar" style="margin-left:20px;">
      <div class="tab-pane active" id="overview">
        <ul class="unstyled">
          <% if @project.projectable_type == "Group" %>
            <li>Module: <%= link_to(@project.projectable.cluster.name, @project.projectable.cluster) %></li>
            <li>Group: <%= link_to(@project.projectable.name, @project.projectable) %></li>
          <% else %>
            <li>Module: <%= link_to(@project.projectable.name, @project.projectable) %></li>
          <% end %>
          <small>
            <li style="margin-top:20px;">Creator: <%= name_only_or_link_to(@project.creator) %></li>
            <li>Created on: <%= @project.created_at.strftime('%d. %b %Y (%H:%M)') %></li>
          </small>
        </ul>
        <%= content_tag :p, 'Bibliography is available as root bibliography' if @project.show_references == true %>
      </div>
      <div class="tab-pane" id="members">
        <ul class="unstyled">
          <% for membership in @project.memberships do %>
            <li><%= name_only_or_link_to(membership.user) %><%= ' ('+membership.role+')' %></li>
          <% end %>
        </ul>
      </div>
    </div>




<!-- Modals beginn -->

    <div id="add_todo" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Add a todo</h3>
      </div>
  
      <%= form_for [@project, @project.todos.new], :html => { :class => 'form-horizontal' } do |f| %>
        <div class="modal-body">
          <%= f.error_messages %>
          <%= f.hidden_field :project_id %>
          <%= f.hidden_field :completed, value: 'f' %>
          <div class="control-group">
            <%= f.label :name, 'Task', class: 'control-label' %>
            <div class="controls">
              <%= f.text_field :name, placeholder: 'Name' %>
            </div>
          </div>
      
          <div class="control-group">
            <%= f.label :assigned_id, class: 'control-label' %>
            <div class="controls">
              <%= f.collection_select :assigned_id, @project.members, :id, :available_name, prompt: "Who's assigned?" %>
            </div>
          </div>
      
          <div class="control-group">
            <%= f.label :due_to_text, 'Due to', class: 'control-label' %>
            <div class="controls">
              <div class="input-append date">
                <%= f.text_field :due_to_text, placeholder: 'Due to', :'data-behaviour' => 'datepicker' %>
                <span class="add-on"><i class="icon-th"></i></span>
              </div>
            </div>
          </div>

          <small><a href="#" data-toggle="collapse" data-target="#todo-options">More options</a></small>
          <div class="collapse" id="todo-options">
            <div class="control-group">
              <%= f.label :starts_at, 'Start', class: 'control-label' %>
              <div class="controls">
                <div class="input-append date">
                  <%= f.text_field :starts_at_text, placeholder: 'Starts at', :'data-behaviour' => 'datepicker' %>
                  <span class="add-on"><i class="icon-th"></i></span>
                </div> 
              </div>
            </div>
            <%= f.fields_for :todo_dependencies do |builder| %>
              <%= render "todos/todo_dependency_fields", :f => builder %>
            <% end %>
            <p class="links controls">
              <%= link_to_add_association "Add Dependency", f, :todo_dependencies, :partial => 'todos/todo_dependency_fields' %>
            </p>
          </div>
        
        </div>
  
        <div class="modal-footer">
          <%= f.submit 'Save', class: 'btn btn-primary pull-left' %>
          <a href="#" class="btn pull-left" data-dismiss="modal">Close</a>
        </div>
      <% end %>
    </div>


<% end %>